# First
Just another repository
# FusionCompute

## 内存复用

### 定义

- 开启内存复用功能将主机的物理内存虚拟出更多内存资源提供给vm使用，使vm的内存规格总和可以大于物理机的内存，提高主机的vm密度，内存利用率

### 技术

- 内存共享

	- vm(相同OS)之间共享同一物理内存空间，vm对共享的内存资源做只读操作。当vm需要进行写操作时，开辟另一部分内存空间写入，并修改映射

- 内存置换

	- vm长时间未访问内存内容被置换到vm余外创建的一个磁盘中，并建立映射，当vm再次访问该内存内容时再置换到内存中

		- 内存交换磁盘

			- 开启后系统自动再系统所在的数据存储创建
			- 大小：(内存大小x1024+128)x11/10240的值向上取整数
			- 作用

				- 虚拟机休眠

					- 内存数据写入该磁盘，以便唤醒时快速回复内存数据

				- 内存超分配

- 内存气泡

	- 在同一集群内将较为空闲的vm内存释放，给内存负载较高的vm使用

		- Blloon driver从源vm申请可用内存页，通过Grant table授权给目标vm并更新物理内存和虚拟机内存的映射

### 关闭时注意什么

- 需要调整集群内运行vm的内存预留=规格。可以通过批量修改vm的内存QOS操作修改内存预留为100%，再进行关闭

### 作用

- 提高主机内存利用率
- 提高主机上vm的密度，复用比提升至15(2)0%，节约成本

### 限制

- 集群内使用直通模式无法开启内存复用

	- 将网卡的内存转换成vm内存，内存来存放队列，vmdq划分出多个队列，每个队列对应一个vm

- 与numa冲突同时开启，gust numa失效
- 每个计算节点上的所有vm预留内存总和不能大于物理内存

### 出现资源抢占

- 通过设置QOS保证关键业务运行

	- 设置内存预留，设置份额

## 迁移

### 主机热迁移

- 定义

	- 将运行中的vm从一台主机迁移到另一台主机上的过程，迁移过程中不中断vm上的业务

- 场景

	- 进行服务器升级维护
	- 虚拟机的资源调度

		- DRS
		- DPM

- 约束

	- 虚拟机

		- 正在运行
		- 已安装tools且tools运行正常

			- tools功能

				- 为vm提供高性能的磁盘IO，网络IO
				- 提供虚拟机硬件监控
				- 为虚拟机提供高级特性

					- 迁移虚拟机
					- 安全关闭虚拟机，重启虚拟机，休眠
					- 在线调整cpu规格
					- 快照
					- vm蓝屏检测
					- vm与ntp同步
					- vm网卡高级功能，qos，流量整形
					- 自动升级vm驱动程序

		- 虚拟机未绑定图形处理设备，USB设备等外置设备
		- 没有与主机绑定，没有设置策略

	- 主机

		- 目标主机没有进入维护模式
		- 确保目标主机资源足够
		- 迁移过程中不能重启、下电
		- cpu类型需一致，源目主机cpu同厂商不同代的话需要开启IMC模式

			- IMC模式目前仅支持inter不同型号cpu的热迁

		- 跨集群迁移

			- 源主机所在集群和目标主机所在集群内存复用开关需一致

	- 存储

		- 虚拟机所在数据存储为共享存储(仅支持在虚拟化数据存储间进行迁移)

	- 网络

		- 主机在相同DVS
		- 源目主机间网络需要通

- 过程

	- 将vm的配置和设备信息传送到目标主机上，并创建vm
	- 将源虚拟机的初始内存和迁移过程中内存变更分片同步到目标主机上

		- 基于内存压缩传输技术：fc使用零页内存压缩技术，全零页保留一份

	- 暂停源vm，将最后的变更内存传到目标主机
	- 在目标主机上恢复vm，并停止源vm

- 迁移失败原因

	- 网络不通

		- 主机间网络
		- 目标主机到共享存储网络

	- 目标主机资源不足
	- cpu内存不兼容
	- 迁移超时时间(集群资源控制中设置)

- 迁移失败如何处理

	- 不会对源端造成影响，停止迁移，接触源vm暂停状态对外继续提供业务

### 存储热迁移

- 定义

	- vm正常运行，将vm磁盘从一个数据存储迁移到另一个数据存储可以vm所有磁盘整体迁移，也可以单个磁盘分别迁移

- 约束

	- 目标存储有足够的容量
	- 热迁移

		- 目标数据存储必须为虚拟化数据存储

			- 源数据存储可以不是虚拟化数据存储，要开启基本块存储

		- 不支持已挂载共享类型磁盘和链接克隆虚拟机的磁盘
		- 不支持非持久化磁盘和开启icache虚拟机磁盘迁移

			- 可以关机迁移

	- 冷迁移

		- 目标为块，不支持非持久化磁盘，和带快照磁盘

			- 非持久化：差分磁盘文件

- 原理

	- 在目标存储上创建与源相同的空镜像文件
	- 将目标存储上的镜像文件设置为源的mirror，使虚拟机的io同时落在源目镜像文件上
	- 将源镜像的数据迁移到目标镜像中，保证基线数据的同步
	- 基线数据同步完成后，暂停vmio，将vm的存储文件从源镜像切换到目标镜像

- 场景

	- 对数据存储进行扩容
	- 调整存储间负载
	- 降低成本
	- 改变磁盘类型(精简、普通、普通置零)

		- 源是普通卷，迁移后可以选择

延迟置零卷——精简

精简卷——保持不变

### 整机热迁移

- 先迁移存储再迁移主机

## HA

### 定义

- 是一种高可用特性，物理机或vm故障时，会根据集群HA策略将宕掉的vm在正常工作的主机上开启，从而减少业务中断时间

	- 策略：虚拟机集群内恢复          虚拟机原主机恢复          停止虚拟机

### 过程

- 主机或vm故障

	- 蓝屏检测需要tools
	- 集中式或集群自治式

- vrm或master节点检测到vm故障
- 判断vm是否有ha属性，根据保存的vm信息(规格、卷)选择可用的cna主机
- cna节点收到请求，根据vm规格、卷信息启动新的vm
- 启动过程中将源虚拟机的卷重新挂载，包括用户卷

### 条件

- 必须是共享存储
- 没有绑定外设
- 集群内有足够资源

### 资源预留方式

- 集群内按照配置值预留cpu与内存资源
- 指定专用故障切换主机
- 集群允许主机故障数量

## xen和kvm区别

### 资源占用

- xen可以保障虚拟化平台资源调度的下线，根据业务类型进行动态调整
- 动态的资源调度，不可控

## 计算资源调度

### DRS

- 定义

	- 动态资源调度，根据调度策略自动实现集群内主机的负载均衡

		- DRS：根据智能负载均衡算法，周期性检查集群内主机的负载（CPU和内存）情况，在不同的主机之间迁移虚拟机，从而达到集群内主机间的负载均衡目的，保证系统良好的用户体验

- 配置

	- 集群内主机性能负载低于调度基线不启用调度
	- 设置调度基线

		- cpu占有率
		- 内存占有率

	- 自动化级别

		- 手动
		- 自动

	- 迁移阈值

- 场景

	- 适用于vm业务具有较明显的持续性波峰和波谷，用户需要获取更好性能体验的场景

### DPM

- 定义

	- 动态电源管理，智能控制主机上下电

根据drs策略将低负载主机上的vm迁走并下电

对于负载超过设置阈值的主机，系统智能选择一定数量主机上电

- 条件

	- 配置主机BMC，电源管理才生效
	- 电源管理依赖于计算资源调度，并且迁移阈值设置不为保守

		- 要看整体的利用率进行迁移下电，调度基线以下
		- 保守：不干预集群的负载失衡

### 优先级

## 两虚拟机不通

### 通过vm的流量走向，从内到外分析

### 场景

- 同一主机

	- 相同端口组
	- 不同端口组

- 不同主机

	- 相同端口组
	- 不同端口组

### 故障点

- vm

	- 防火墙
	- ip地址配置错误
	- 网卡是否禁用

- 端口组

	- vlan配置
	- 端口类型

- dvs
- 上行链路

	- 是否故障
	- 是否双网卡绑定

- sw

	- 物理故障
	- 是否开启路由功能
	- 是否放行vlan

## 云计算和虚拟化

### 云计算

- 云计算是一种按使用量计费的模式，这种模式可提供可用的，便捷的，按需网络访问，进入可配置的资源池包括，计算存储网络应用服务，这些资源能够快速提供，只需要投入少的管理工作
- 优势

	- 按需自助服务
	- 无处不在的网路接入
	- 与位置无关的资源池
	- 快速弹性
	- 按使用付费
	- 云计算偏向于服务的管理和业务的自动化运营，使业务的上线周期大大缩短，同时屏蔽底层的资源提供方式，做到兼容异构，用户只需要关心自己需要的资源是什么，多少，不需要关心资源是如何提供的

### 区别

- 虚拟化

	- 虚拟化是一种具体的技术，实现了对硬件资源的虚拟化，更多的关注于如何提升资源利用率，降低虚拟化带来的损耗以及提供虚拟化高级特性
	- 本质

		- 分区
		- 隔离 
		- 封装
		- 相对硬件独立

- 云计算

	- 是各种技术组件的集合，针对的是各种资源的管理和调度以及对客户的服务，面向的是服务层面

## 存储虚拟化

### 磁盘文件

- 固态磁盘

	- 创建时将磁盘文件对应的存储块空间全部置零

- 动态磁盘

	- 精简卷:创建时只写头和结束块，磁盘大小随着用户写入而变大，但不会随着用户删除数据而减少，只能通过空间回收来手动缩减普通置零卷:首次写入全部置零

- 差分盘

	- 结构和动态磁盘一样，只是文件头会记录父文件路径配合快照、非持久化磁盘、链接克隆虚拟机使用

### 快照

- 定义

	- 在虚拟化平台能够有效保护虚拟机数据的一种技术
	- 快照记录了vm再某一时间点的状态
	- 通过恢复快照使vm多次快速恢复到某个时间点

- 要求

	- vm所在存储为虚拟化数据存储高级san或者fs
	- vm安装tools且正常运行关机拍快照可不安装tools

- 原理

	- 创建快照时生成差分卷，vm挂载差分卷作为磁盘文件，vm读请求会重定向到原卷

- 场景

	- 执行高危操作或升级，容灾复制之前都为vm拍快照，可以在失败后快速还原回原有的状态

- 谁做的快照

## 网络虚拟化

### 模式

- 普通网卡

	- 通过domain0接收io，domain0进行io队列排序和io转发

- vmdq

	- 建立网卡的内存和vm内存的映射，vmdq划分出多个队列，每个vm对应一个队列，vm出来的流量直接发送到指定队列，hypervisor还需要完成一次转换

- sr-iov

	- 创建多个虚拟网卡，呈现给vm的就是一个独立的网卡，vm直接跟网卡通信

### 虚拟交换机

- OVS

	- 是一款基于软件实现的开源虚拟以太网交换机支持多种管理接口协议，提供了openflow协议，并与众多开源的虚拟化平台相整合
	- 特性最全

- DVS

	- 华为的分布式虚拟交换机，将各主机的ovs进行逻辑上的整合，实现统一管理配置。通过上行链路与主机关联，通过端口组与虚拟机关联。

- EVS

	- 在ovs的基础上支持智能网卡的虚拟交换支持完成虚拟交换卸载，提升了io性能，仍然遵从openflow协议，io性能提升使用了intel dpdk，通过用户态进程接管网卡数据收发，采用一个端口分配一个核用于数据收发，这种轮询方式比中断处理效果更高效，因而io性能有提升
	- 所有vs都采用vmdq，每个节点上增强后的vs组成的dvs叫evs
	- 不支持安全组，vxlan，不支持限速

### 端口组

- 普通

	- 数据帧到达端口打上vlan tag

- 中继

	- 放行指定vlan，vlan tag出网卡已经打好的，vm自己打tag

*XMind: ZEN - Trial Version*
